<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>ðŸ”¥ Advanced Comic Thumbnail Editor</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Anton&family=Bangers&family=Bungee&family=Luckiest+Guy&family=Poppins:wght@300;500;700&family=Comic+Neue:wght@700&family=Impact&family=Bebas+Neue&family=Oswald:wght@700&family=Roboto+Condensed:wght@700&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --primary: #6d28d9;
      --primary-dark: #5b21b6;
      --accent: #f59e0b;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
    }

    body {
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      padding: 2rem;
      line-height: 1.6;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background-size: 300% 300%;
      background-image: linear-gradient(
        45deg,
        var(--bg-main) 0%,
        var(--bg-gradient) 50%,
        var(--bg-main) 100%
      );
      animation: gradientBG 15s ease infinite;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    body[data-theme="dark"] {
      --bg-main: #0f172a;
      --bg-gradient: #1e293b;
      --bg-surface: #1e293b;
      --bg-control: rgba(30, 41, 59, 0.9);
      --bg-input: rgba(15, 23, 42, 0.7);
      --text-main: #f8fafc;
      --text-light: #e2e8f0;
      --text-lighter: #94a3b8;
      --border-color: #334155;
      --shadow-color: rgba(2, 6, 23, 0.5);
      --shadow-hover-color: rgba(109, 40, 217, 0.3);
      --glass-effect: rgba(30, 41, 59, 0.5);
    }

    body[data-theme="light"] {
      --bg-main: #f1f5f9;
      --bg-gradient: #e2e8f0;
      --bg-surface: #ffffff;
      --bg-control: rgba(255, 255, 255, 0.9);
      --bg-input: #f8fafc;
      --text-main: #0f172a;
      --text-light: #475569;
      --text-lighter: #94a3b8;
      --border-color: #cbd5e1;
      --shadow-color: rgba(100, 116, 139, 0.2);
      --shadow-hover-color: rgba(109, 40, 217, 0.1);
      --glass-effect: rgba(255, 255, 255, 0.7);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 2.5rem;
      position: relative;
    }

    header h1 {
      font-size: 2.8rem;
      font-weight: 700;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      display: inline-block;
      position: relative;
      padding: 0 1rem;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      letter-spacing: 0.5px;
    }

    header h1::after {
      content: '';
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(109, 40, 217, 0.3);
    }

    #themeToggle {
      position: absolute;
      top: 50%;
      right: 0;
      transform: translateY(-50%);
      background: var(--glass-effect);
      border: none;
      color: var(--text-light);
      width: 44px;
      height: 44px;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 6px var(--shadow-color);
    }

    #themeToggle:hover {
      color: var(--accent);
      transform: translateY(-50%) scale(1.1);
      box-shadow: 0 6px 12px var(--shadow-hover-color);
    }

    .editor-container {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      justify-content: center;
      align-items: flex-start;
    }

    #controls {
      background: var(--bg-control);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 8px 32px var(--shadow-color);
      border: 1px solid var(--border-color);
      width: 100%;
      max-width: 400px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    #controls::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        to bottom right,
        rgba(109, 40, 217, 0.1),
        rgba(245, 158, 11, 0.1),
        transparent
      );
      transform: rotate(30deg);
      z-index: -1;
    }

    #controls:hover {
      box-shadow: 0 12px 32px var(--shadow-hover-color);
      transform: translateY(-2px);
    }

    .control-group {
      margin-bottom: 1.8rem;
      animation: fadeIn 0.5s ease forwards;
      position: relative;
    }

    .control-group::after {
      content: '';
      position: absolute;
      bottom: -0.9rem;
      left: 0;
      width: 100%;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--border-color), transparent);
    }

    .control-group:last-child::after {
      display: none;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    label {
      display: block;
      margin-bottom: 0.75rem;
      font-weight: 600;
      color: var(--text-light);
      font-size: 0.9rem;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    label i {
      margin-right: 10px;
      color: var(--primary);
      width: 20px;
      text-align: center;
    }

    input,
    button,
    select {
      width: 100%;
      padding: 0.9rem 1.2rem;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      font-family: 'Poppins', sans-serif;
      font-size: 0.95rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--bg-input);
      color: var(--text-main);
    }

    textarea {
      width: 100%;
      padding: 0.9rem 1.2rem;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      font-family: 'Poppins', sans-serif;
      font-size: 0.95rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--bg-input);
      color: var(--text-main);
      resize: vertical;
      min-height: 100px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.2);
    }

    input[type="range"] {
      -webkit-appearance: none;
      height: 8px;
      background: var(--border-color);
      border-radius: 4px;
      padding: 0;
      margin-top: 0.5rem;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      border: 2px solid var(--bg-surface);
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.15);
      background: var(--primary-dark);
    }

    input[type="color"] {
      -webkit-appearance: none;
      padding: 0;
      border: none;
      width: 46px;
      height: 46px;
      background: none;
      cursor: pointer;
      border-radius: 12px;
      overflow: hidden;
    }

    input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
    }

    input[type="color"]::-webkit-color-swatch {
      border: 2px solid var(--border-color);
      border-radius: 10px;
    }

    .color-and-slider {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .color-and-slider input[type="range"] {
      margin-top: 0;
      flex-grow: 1;
    }

    .text-style-inputs {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      margin-top: 0.75rem;
    }

    .text-style-inputs input[type="number"] {
      flex-basis: 25%;
      text-align: center;
    }

    .text-style-inputs select {
      flex-grow: 1;
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      border-radius: 12px;
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-input-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 1rem 1.2rem;
      border: 2px dashed var(--border-color);
      border-radius: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      background: rgba(109, 40, 217, 0.05);
    }

    .file-input-label:hover {
      border-color: var(--primary);
      background: rgba(109, 40, 217, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow-hover-color);
    }

    .file-input-label i {
      color: var(--primary);
      font-size: 1.2rem;
    }

    .file-input-label span {
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .file-input-wrapper:hover .file-input-label span {
      color: var(--primary);
    }

    .dimension-inputs {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    .dimension-inputs input {
      text-align: center;
      font-weight: 600;
    }

    #viewportContainer {
      border-radius: 20px;
      box-shadow: 0 8px 32px var(--shadow-color);
      border: 5px solid var(--bg-surface);
      position: relative;
      overflow: auto;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--bg-surface);
    }

    #viewportContainer:hover {
      box-shadow: 0 12px 32px var(--shadow-hover-color);
      transform: translateY(-2px);
    }

    #imageCanvas {
      display: block;
      cursor: grab;
      border-radius: 15px;
    }

    #imageCanvas:active {
      cursor: grabbing;
    }

    #textPreview {
      position: absolute;
      text-align: center;
      cursor: move;
      user-select: none;
      z-index: 10;
      padding: 0.75rem;
      transition: transform 0.1s ease;
      line-height: 1.1;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      pointer-events: auto;
    }

    #textPreview:active {
      transform: scale(1.02);
    }

    .download-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    .download-btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      font-weight: 600;
      letter-spacing: 0.5px;
      border: none;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      flex: 1;
      border-radius: 12px;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 6px var(--shadow-color);
    }

    .download-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
      );
      transition: all 0.6s ease;
    }

    .download-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 16px var(--shadow-hover-color);
    }

    .download-btn:hover::before {
      left: 100%;
    }

    .download-btn:active {
      transform: translateY(0);
    }

    .download-btn i {
      margin-right: 8px;
      font-size: 1.1rem;
    }

    .download-btn.toned {
      background: linear-gradient(135deg, #64748b, #475569);
    }

    .download-btn.toned:hover {
      box-shadow: 0 8px 16px rgba(100, 116, 139, 0.3);
    }

    .download-btn.hd {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    }

    .download-btn.hd:hover {
      box-shadow: 0 8px 16px rgba(139, 92, 246, 0.3);
    }

    #viewportContainer::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    #viewportContainer::-webkit-scrollbar-track {
      background: var(--bg-surface);
      border-radius: 5px;
    }

    #viewportContainer::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 5px;
    }

    #viewportContainer::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    small {
      display: block;
      margin-top: 0.5rem;
      color: var(--text-lighter);
      font-size: 0.8rem;
      font-style: italic;
    }

    /* Tooltip styles */
    [title] {
      position: relative;
    }

    [title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-surface);
      color: var(--text-main);
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      font-size: 0.8rem;
      white-space: nowrap;
      box-shadow: 0 2px 8px var(--shadow-color);
      border: 1px solid var(--border-color);
      z-index: 100;
      pointer-events: none;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      body {
        padding: 1rem;
        background-image: none;
        background: var(--bg-main);
      }

      header h1 {
        font-size: 2rem;
        padding: 0 0.5rem;
      }

      .editor-container {
        flex-direction: column;
      }

      #controls,
      #viewportContainer {
        max-width: 100%;
      }

      #themeToggle {
        top: -2.5rem;
        right: 0;
        border-radius: 10px;
      }

      .download-buttons {
        flex-direction: column;
      }

      .control-group::after {
        bottom: -0.8rem;
      }
    }

    /* Animation for control groups */
    .control-group:nth-child(1) { animation-delay: 0.1s; }
    .control-group:nth-child(2) { animation-delay: 0.2s; }
    .control-group:nth-child(3) { animation-delay: 0.3s; }
    .control-group:nth-child(4) { animation-delay: 0.4s; }
    .control-group:nth-child(5) { animation-delay: 0.5s; }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body data-theme="dark">
  <div class="container">
    <header>
      <h1>Advanced Comic Thumbnail Editor</h1>
      <button id="themeToggle" title="Toggle Theme"><i class="fas fa-sun"></i></button>
    </header>
    <div class="editor-container">
      <div id="controls">
        <div class="control-group">
          <label><i class="fas fa-image"></i>1. Setup</label>
          <div class="file-input-wrapper">
            <input type="file" id="imageInput" accept="image/*">
            <div class="file-input-label" id="fileLabel">
              <i class="fas fa-cloud-upload-alt"></i><span>Choose Image</span>
            </div>
          </div>
          <div class="dimension-inputs">
            <input type="number" id="canvasWidthInput" value="400" title="Width" placeholder="Width">
            <input type="number" id="canvasHeightInput" value="758" title="Height" placeholder="Height">
          </div>
        </div>

        <div class="control-group" id="positionControls" style="display: none;">
          <label><i class="fas fa-search-plus"></i>2. Zoom</label>
          <input type="range" id="zoomSlider" min="100" max="800" value="100" step="1">
          <small>Use scrollbars or drag on image to pan.</small>
        </div>

        <div class="control-group">
          <label><i class="fas fa-heading"></i>3. Add Text</label>
          <textarea id="comicTitleInput" placeholder="Your Epic Title Here..."></textarea>
          <div class="text-style-inputs">
            <input type="number" id="fontSizeInput" value="70" placeholder="Size" title="Font Size (px)">
            <input type="color" id="textColorInput" value="#FFFFFF" title="Text Color">
            <select id="fontFamilySelect">
              <option value="Anton">Anton</option>
              <option value="Bungee">Bungee</option>
              <option value="Bangers">Bangers</option>
              <option value="Luckiest Guy">Luckiest Guy</option>
              <option value="Comic Neue">Comic Neue</option>
              <option value="Impact">Impact</option>
              <option value="Bebas Neue">Bebas Neue</option>
              <option value="Oswald">Oswald</option>
              <option value="Roboto Condensed">Roboto Condensed</option>
              <option value="Poppins">Poppins</option>
            </select>
          </div>
          <div class="color-and-slider" style="margin-top: 0.75rem;">
            <input type="number" id="lineHeightInput" value="1.1" step="0.1" min="0.8" max="3" title="Line Height">
            <small>Line height (0.8-3)</small>
          </div>
        </div>

        <div class="control-group">
          <label><i class="fas fa-border-style"></i>4. Text Border</label>
          <div class="color-and-slider">
            <input type="color" id="textBorderColorInput" value="#000000" title="Border Color">
            <input type="range" id="textBorderWidthInput" min="0" max="15" value="4" step="1" title="Border Width">
          </div>
        </div>

        <div class="control-group">
            <label><i class="fas fa-download"></i>5. Generate</label>
            <div class="download-buttons">
              <button class="download-btn" id="normalDownloadBtn" title="Download Normal Quality"><i class="fas fa-download"></i>Normal</button>
              <button class="download-btn toned" id="tonedDownloadBtn" title="Download Grayscale Version"><i class="fas fa-filter"></i>Toned</button>
              <button class="download-btn hd" id="hdDownloadBtn" title="Download High Quality"><i class="fas fa-star"></i>HD</button>
            </div>
        </div>
      </div>

      <div id="viewportContainer">
        <canvas id="imageCanvas"></canvas>
      </div>
      <span id="textPreview"></span>
    </div>
  </div>

  <script>
    // DOM Elements
    const viewportContainer = document.getElementById('viewportContainer');
    const canvas = document.getElementById('imageCanvas');
    const ctx = canvas.getContext('2d');
    const imageInput = document.getElementById('imageInput');
    const zoomSlider = document.getElementById('zoomSlider');
    const normalDownloadBtn = document.getElementById('normalDownloadBtn');
    const tonedDownloadBtn = document.getElementById('tonedDownloadBtn');
    const hdDownloadBtn = document.getElementById('hdDownloadBtn');
    const positionControls = document.getElementById('positionControls');
    const comicTitleInput = document.getElementById('comicTitleInput');
    const fontSizeInput = document.getElementById('fontSizeInput');
    const lineHeightInput = document.getElementById('lineHeightInput');
    const textPreview = document.getElementById('textPreview');
    const themeToggle = document.getElementById('themeToggle');
    const textColorInput = document.getElementById('textColorInput');
    const fontFamilySelect = document.getElementById('fontFamilySelect');
    const textBorderColorInput = document.getElementById('textBorderColorInput');
    const textBorderWidthInput = document.getElementById('textBorderWidthInput');

    // State
    const BORDER_SIZE = 5;
    let img = new Image();
    let imgLoaded = false;
    let scale = 1.0;
    let isInitialTextPosition = true;

    // Dragging state for image panning
    let isPanningImage = false;
    let panStart = { x: 0, y: 0, scrollLeft: 0, scrollTop: 0 };

    // Dragging state for text
    let isDraggingText = false;
    let textDragStart = { x: 0, y: 0, posX: 0, posY: 0 };

    function setupEventListeners() {
      imageInput.addEventListener('change', handleImageUpload);
      document.getElementById('canvasWidthInput').addEventListener('input', updateViewportSize);
      document.getElementById('canvasHeightInput').addEventListener('input', updateViewportSize);
      zoomSlider.addEventListener('input', handleZoom);
      normalDownloadBtn.addEventListener('click', () => generateAndDownload('normal'));
      tonedDownloadBtn.addEventListener('click', () => generateAndDownload('toned'));
      hdDownloadBtn.addEventListener('click', () => generateAndDownload('hd'));
      themeToggle.addEventListener('click', toggleTheme);

      // Text controls
      comicTitleInput.addEventListener('input', () => { isInitialTextPosition = false; updateTextPreview(); });
      fontSizeInput.addEventListener('input', () => { isInitialTextPosition = false; updateTextPreview(); });
      lineHeightInput.addEventListener('input', () => { isInitialTextPosition = false; updateTextPreview(); });
      textColorInput.addEventListener('input', updateTextPreview);
      fontFamilySelect.addEventListener('change', () => { isInitialTextPosition = false; updateTextPreview(); });
      textBorderColorInput.addEventListener('input', updateTextPreview);
      textBorderWidthInput.addEventListener('input', updateTextPreview);
      
      // Image Panning
      canvas.addEventListener('mousedown', (e) => {
        isPanningImage = true;
        panStart = {
          x: e.pageX, y: e.pageY,
          scrollLeft: viewportContainer.scrollLeft, scrollTop: viewportContainer.scrollTop
        };
      });

      // Text dragging
      textPreview.addEventListener('mousedown', (e) => {
        e.preventDefault();
        isDraggingText = true;
        isInitialTextPosition = false;
        textDragStart = {
          x: e.pageX, y: e.pageY,
          posX: textPreview.offsetLeft, posY: textPreview.offsetTop
        };
      });

      window.addEventListener('mouseup', () => {
        isDraggingText = false;
        isPanningImage = false;
      });

      window.addEventListener('mousemove', (e) => {
        if (isDraggingText) {
          const dx = e.pageX - textDragStart.x;
          const dy = e.pageY - textDragStart.y;
          let newX = textDragStart.posX + dx;
          let newY = textDragStart.posY + dy;
          textPreview.style.left = `${newX}px`;
          textPreview.style.top = `${newY}px`;
        }
        if (isPanningImage) {
          const dx = e.pageX - panStart.x;
          const dy = e.pageY - panStart.y;
          viewportContainer.scrollLeft = panStart.scrollLeft - dx;
          viewportContainer.scrollTop = panStart.scrollTop - dy;
        }
      });
    }

    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      document.getElementById('fileLabel').innerHTML = `<i class="fas fa-check-circle" style="color:var(--success)"></i><span>${file.name}</span>`;

      const reader = new FileReader();
      reader.onload = (e) => {
        img.onload = () => {
          imgLoaded = true;
          positionControls.style.display = 'block';
          updateViewportSize();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Correct text wrapping logic
    function getWrappedText(text, maxWidth, font) {
        const words = text.split(' ');
        if (words.length === 0 || text === '') return [];
        
        let lines = [];
        let currentLine = words[0];
        const tempCtx = document.createElement('canvas').getContext('2d');
        tempCtx.font = font;

        for (let i = 1; i < words.length; i++) {
            const word = words[i];
            const testLine = currentLine ? `${currentLine} ${word}` : word;
            const width = tempCtx.measureText(testLine).width;
            if (width < maxWidth) {
                currentLine = testLine;
            } else {
                lines.push(currentLine);
                currentLine = word;
            }
        }
        lines.push(currentLine);
        return lines.filter(line => line);
    }

    function updateViewportSize() {
      const width = parseInt(document.getElementById('canvasWidthInput').value) || 400;
      const height = parseInt(document.getElementById('canvasHeightInput').value) || 758;
      
      // Set the container size, accounting for the border width.
      // The CSS border is 5px, so total border width/height is 10px.
      viewportContainer.style.width = `${width}px`;
      viewportContainer.style.height = `${height}px`;

      if (imgLoaded) {
        resetZoomAndPosition();
      }
      isInitialTextPosition = true;
      updateTextPreview();
    }

    function handleZoom() {
      scale = parseFloat(zoomSlider.value) / 100;
      redrawCanvas();
    }

    function redrawCanvas() {
      if (!imgLoaded) return;
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    }

    function applyFinalEffects(targetCtx, width, height, mode) {
        if (mode === 'toned') {
            const imageData = targetCtx.getImageData(0, 0, width, height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                data[i] = avg;     // red
                data[i + 1] = avg; // green
                data[i + 2] = avg; // blue
            }
            targetCtx.putImageData(imageData, 0, 0);
        } else if (mode === 'hd') {
            targetCtx.filter = 'contrast(1.2) saturate(1.2)';
            targetCtx.drawImage(targetCtx.canvas, 0, 0, width, height, 0, 0, width, height);
            targetCtx.filter = 'none'; // Reset filter
        }
    }

    function updateTextPreview() {
      const text = comicTitleInput.value;
      const fontSize = parseInt(fontSizeInput.value) || 70;
      const fontFamily = fontFamilySelect.value;
      const lineHeight = parseFloat(lineHeightInput.value) || 1.1;
      const borderWidth = parseInt(textBorderWidthInput.value) || 4;
      const font = `bold ${fontSize}px '${fontFamily}'`;
      // The max width for text should be the inner width of the container
      const maxWidth = viewportContainer.clientWidth - 20;

      const wrappedLines = getWrappedText(text, maxWidth, font);
      textPreview.innerHTML = wrappedLines.join('<br>');

      textPreview.style.fontFamily = `'${fontFamily}', sans-serif`;
      textPreview.style.fontSize = `${fontSize}px`;
      textPreview.style.color = textColorInput.value;
      textPreview.style.webkitTextStroke = `${borderWidth}px ${textBorderColorInput.value}`;
      textPreview.style.lineHeight = `${lineHeight}`;

      if (isInitialTextPosition) {
        repositionTextPreview();
      }
    }

    function repositionTextPreview() {
      const rect = viewportContainer.getBoundingClientRect();
      document.body.appendChild(textPreview);
      textPreview.style.top = `${rect.top + window.scrollY + (rect.height * 0.85) - (textPreview.offsetHeight / 2)}px`;
      textPreview.style.left = `${rect.left + window.scrollX + (rect.width / 2) - (textPreview.offsetWidth / 2)}px`;
    }

    function generateAndDownload(mode) {
      if (!imgLoaded) {
        alert("Please upload an image first.");
        return;
      }
      
      const contentWidth = viewportContainer.clientWidth;
      const contentHeight = viewportContainer.clientHeight;
      
      // Final canvas includes space for the border
      const finalCanvas = document.createElement('canvas');
      finalCanvas.width = contentWidth + (BORDER_SIZE * 2);
      finalCanvas.height = contentHeight + (BORDER_SIZE * 2);
      const finalCtx = finalCanvas.getContext('2d');

      // 1. Fill background with white for the border
      finalCtx.fillStyle = 'white';
      finalCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
      
      // 2. Draw the visible part of the ORIGINAL image to the final canvas, offset by the border
      const sx = viewportContainer.scrollLeft / scale;
      const sy = viewportContainer.scrollTop / scale;
      const sWidth = contentWidth / scale;
      const sHeight = contentHeight / scale;
      
      finalCtx.drawImage(img, sx, sy, sWidth, sHeight, BORDER_SIZE, BORDER_SIZE, contentWidth, contentHeight);
      
      // 3. Apply effects to the final canvas IF required
      applyFinalEffects(finalCtx, finalCanvas.width, finalCanvas.height, mode);

      // 4. Text Drawing
      const viewportRect = viewportContainer.getBoundingClientRect();
      const textRect = textPreview.getBoundingClientRect();
      const fontSize = parseInt(fontSizeInput.value) || 70;
      const fontFamily = fontFamilySelect.value;
      const lineHeight = parseFloat(lineHeightInput.value) || 1.1;
      const font = `bold ${fontSize}px '${fontFamily}'`;
      const lineHeightPx = fontSize * lineHeight;
      const maxWidth = contentWidth - 20;

      const wrappedLines = getWrappedText(comicTitleInput.value, maxWidth, font);
      
      // Calculate text position relative to the viewport, then add border offset
      const totalTextHeight = (wrappedLines.length - 1) * lineHeightPx;
      const startX = textRect.left - viewportRect.left + (textRect.width / 2) + BORDER_SIZE;
      let startY = textRect.top - viewportRect.top + (textRect.height / 2) - (totalTextHeight / 2) + BORDER_SIZE;

      finalCtx.font = font;
      finalCtx.textAlign = 'center';
      finalCtx.textBaseline = 'middle';
      finalCtx.fillStyle = textColorInput.value;
      finalCtx.strokeStyle = textBorderColorInput.value;
      finalCtx.lineWidth = parseInt(textBorderWidthInput.value);

      wrappedLines.forEach((line, index) => {
        const yPos = startY + (index * lineHeightPx);
        if (finalCtx.lineWidth > 0) {
          finalCtx.strokeText(line, startX, yPos);
        }
        finalCtx.fillText(line, startX, yPos);
      });

      // --- Trigger download ---
      const link = document.createElement('a');
      link.download = `thumbnail_${mode}_bordered.jpeg`;
      link.href = finalCanvas.toDataURL('image/jpeg', mode === 'hd' ? 1.0 : 0.9);
      link.click();
    }

    function resetZoomAndPosition() {
      const scaleToFit = Math.max(
        viewportContainer.clientWidth / img.width,
        viewportContainer.clientHeight / img.height
      );
      scale = scaleToFit;
      zoomSlider.value = scale * 100;
      zoomSlider.min = scale * 100;

      redrawCanvas();
      viewportContainer.scrollLeft = (canvas.width - viewportContainer.clientWidth) / 2;
      viewportContainer.scrollTop = (canvas.height - viewportContainer.clientHeight) / 2;
    }

    function toggleTheme() {
      const currentTheme = document.body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('thumbnail-editor-theme', newTheme);
      themeToggle.innerHTML = newTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    }

    window.onload = () => {
      const savedTheme = localStorage.getItem('thumbnail-editor-theme') || 'dark';
      document.body.setAttribute('data-theme', savedTheme);
      themeToggle.innerHTML = savedTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';

      setupEventListeners();
      
      document.fonts.ready.then(() => {
        updateViewportSize();
      });
    };
  </script>
</body>

</html>